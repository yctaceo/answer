<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANSWER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .line-pre { white-space: pre-line; }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen bg-gray-50">
    <!-- Navigation -->
    <nav class="w-full max-w-md bg-white border-b border-gray-100 flex sticky top-0 z-50">
        <button onclick="switchTab('home')" class="flex-1 py-4 text-sm font-bold border-b-2 border-black" id="btn-home">HOME</button>
        <button onclick="switchTab('body')" class="flex-1 py-4 text-sm font-medium text-gray-400" id="btn-body">MY BODY</button>
    </nav>

    <!-- HOME Tab -->
    <main id="tab-home" class="tab-content active w-full max-w-md flex flex-col h-[calc(100vh-120px)]">
        <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-6 no-scrollbar">
            <div class="text-center py-10">
                <p class="text-gray-300 text-xs tracking-widest uppercase">My Body Signal Partner</p>
                <h2 class="text-xl font-light mt-1">Ïñ¥Îñ§ Ïã†Ìò∏Í∞Ä ÎäêÍª¥ÏßÄÏãúÎÇòÏöî?</h2>
            </div>
            <div id="messages" class="space-y-6 pb-10"></div>
        </div>
        
        <div class="p-4 bg-white border-t border-gray-100">
            <div class="relative flex items-center">
                <input type="text" id="userInput" class="w-full p-4 pr-12 rounded-2xl bg-gray-100 outline-none text-sm" placeholder="Ï¶ùÏÉÅÏùÑ ÎßêÌï¥Ï£ºÏÑ∏Ïöî..." onkeypress="if(event.keyCode==13) sendMessage()">
                <button onclick="sendMessage()" class="absolute right-3 p-2 text-black">‚Üë</button>
            </div>
        </div>
    </main>

    <!-- MY BODY Tab -->
    <main id="tab-body" class="tab-content w-full max-w-md p-6 space-y-8">
        <section>
            <h3 class="text-xs font-bold text-gray-400 mb-4 tracking-tight">RECENT SUMMARY</h3>
            <div id="body-recent" class="bg-white p-6 rounded-3xl shadow-sm text-gray-700 leading-relaxed border border-gray-50 italic">Í∏∞Î°ùÏùÑ ÏãúÏûëÌïòÎ©¥ Ï≤´ ÏöîÏïΩÏù¥ ÎÇòÌÉÄÎÇ©ÎãàÎã§.</div>
        </section>
        <section>
            <h3 class="text-xs font-bold text-gray-400 mb-4 tracking-tight">AREAS I'M WATCHING</h3>
            <div id="body-tags" class="flex flex-wrap gap-2"></div>
        </section>
        <section>
            <h3 class="text-xs font-bold text-gray-400 mb-4 tracking-tight">HISTORY</h3>
            <div id="body-history" class="space-y-4"></div>
        </section>
    </main>

    <script>
        let turns = [];
        let bodyState = JSON.parse(localStorage.getItem('answer_v2') || '{"history": [], "tags": []}');

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('nav button').forEach(el => {
                el.classList.remove('border-black', 'font-bold', 'text-black');
                el.classList.add('text-gray-400', 'font-medium');
            });
            const activeBtn = document.getElementById('btn-' + tab);
            activeBtn.classList.add('border-black', 'font-bold', 'text-black');
            activeBtn.classList.remove('text-gray-400');
            if(tab === 'body') renderBody();
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text) return;
            
            appendMessage('user', text);
            input.value = '';

            try {
                let response;
                const endpoints = ['/api/answer', '/api/chat'];
                for(let url of endpoints) {
                    try {
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ message: text, history: turns })
                        });
                        if(res.ok) { 
                            const json = await res.json();
                            if(json && json.summary) { response = json; break; }
                        }
                    } catch(e) {}
                }
                
                if(response) {
                    appendMessage('bot', response);
                    saveToBody(text, response);
                    turns.push({role: 'user', content: text});
                    turns.push({role: 'assistant', content: JSON.stringify(response)});
                }
            } catch(e) {
                console.error("Error:", e);
            }
        }

        function appendMessage(role, content) {
            const wrap = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = role === 'user' ? 'flex justify-end' : 'flex flex-col items-start w-full';
            
            if(role === 'user') {
                div.innerHTML = `<div class="bg-black text-white px-4 py-2 rounded-2xl rounded-tr-none text-sm max-w-[80%]">${escapeHTML(content)}</div>`;
            } else {
                const refs = content.references ? content.references.map(r => `<div class="py-2 border-t border-gray-50 line-pre text-gray-500">${escapeHTML(r)}</div>`).join('') : '';
                div.innerHTML = `
                    <div class="bg-white border border-gray-100 p-5 rounded-3xl rounded-tl-none w-full shadow-sm space-y-4">
                        <div class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">${escapeHTML(content.evidenceType)}</div>
                        <p class="text-[15px] leading-relaxed text-gray-800">${escapeHTML(content.summary)}</p>
                        <div class="flex flex-wrap gap-1">
                            ${content.top3.map(t => `<span class="bg-gray-50 text-gray-400 px-2 py-0.5 rounded text-[10px]">#${t}</span>`).join('')}
                        </div>
                        <div class="bg-blue-50/50 p-3 rounded-2xl">
                            <span class="text-[10px] text-blue-400 font-bold block mb-1 uppercase italic">One Action</span>
                            <p class="text-sm text-blue-700 font-semibold">${escapeHTML(content.action)}</p>
                        </div>
                        <div class="text-sm font-medium pt-2 italic text-gray-900 border-t border-gray-50">"${escapeHTML(content.nextQuestion)}"</div>
                        ${refs ? `<details class="text-[10px] text-gray-300 mt-2"><summary class="cursor-pointer py-1">References</summary><div class="mt-2">${refs}</div></details>` : ''}
                    </div>
                `;
            }
            wrap.appendChild(div);
            
            const win = document.getElementById('chat-window');
            if (win.scrollHeight - win.scrollTop - win.clientHeight < 300) {
                win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
            }
        }

        function saveToBody(q, data) {
            bodyState.history.unshift({ q, ...data, date: new Date().toLocaleDateString() });
            bodyState.tags = [...new Set([...bodyState.tags, ...data.top3])].slice(0, 15);
            localStorage.setItem('answer_v2', JSON.stringify(bodyState));
        }

        function renderBody() {
            if(bodyState.history.length === 0) return;
            document.getElementById('body-recent').innerText = bodyState.history[0].summary;
            document.getElementById('body-tags').innerHTML = bodyState.tags.map(t => `<span class="px-3 py-1 bg-white border border-gray-100 rounded-full text-xs text-gray-500">#${t}</span>`).join('');
            document.getElementById('body-history').innerHTML = bodyState.history.map(h => `
                <div class="p-4 bg-white rounded-2xl border border-gray-50">
                    <div class="text-[9px] text-gray-300 mb-1">${h.date} | ${escapeHTML(h.evidenceType)}</div>
                    <div class="text-xs text-gray-400 mb-2">Q: ${escapeHTML(h.q)}</div>
                    <div class="text-sm text-gray-800">${escapeHTML(h.summary)}</div>
                    <div class="mt-2 text-[10px] text-red-400">üö© ${escapeHTML(h.redFlag)}</div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
