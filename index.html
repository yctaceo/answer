<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANSWER - Phase 1 Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .premium-shadow {
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 2px 10px -2px rgba(0, 0, 0, 0.03);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: #6366f1; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { color: #6366f1; text-shadow: .25em 0 0 #6366f1, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { color: #6366f1; text-shadow: .25em 0 0 #6366f1, .5em 0 0 #6366f1; }
        }
        /* Mobile Centering */
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
    </style>
</head>
<body>

    <div class="app-container bg-white shadow-xl">
        
        <!-- Main Content Area -->
        <main id="app-content" class="flex-1 pb-24 overflow-y-auto no-scrollbar">
            <!-- Content will be injected here -->
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 w-full max-w-[480px] bg-white/80 backdrop-blur-md border-t border-slate-100 px-6 py-3 flex justify-around items-center z-50">
            <button onclick="switchTab('home')" id="nav-home" class="flex flex-col items-center gap-1 text-indigo-600 transition-all">
                <i data-lucide="message-square" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">HOME</span>
            </button>
            <button onclick="switchTab('body')" id="nav-body" class="flex flex-col items-center gap-1 text-slate-400 transition-all">
                <i data-lucide="brain-circuit" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium">MY BODY</span>
            </button>
        </nav>
    </div>

    <!-- Modal Template -->
    <dialog id="report_modal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box p-0 bg-slate-50 overflow-hidden">
            <div id="modal-content" class="p-6 pb-20"></div>
            <div class="modal-action absolute top-2 right-4">
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost"><i data-lucide="x" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>
    </dialog>

    <script>
        // --- State Management ---
        let currentTab = 'home';
        let history = JSON.parse(localStorage.getItem('answer_history_v1')) || [];
        let currentSession = null; // { id, questions: [], responses: [], step: 0 }
        let isTyping = false;

        const placeholders = [
            "요즘 밤에 잠이 잘 안 와요",
            "식사 후에 항상 속이 더부룩해요",
            "두 달째 생리를 안 하고 있어요",
            "갑자기 가슴이 두근거릴 때가 있어요"
        ];
        let placeholderIdx = 0;

        // --- Core Logic ---

        function init() {
            renderContent();
            updateNav();
            lucide.createIcons();
            startPlaceholderRotation();
        }

        function switchTab(tab) {
            currentTab = tab;
            renderContent();
            updateNav();
            lucide.createIcons();
        }

        function updateNav() {
            const homeBtn = document.getElementById('nav-home');
            const bodyBtn = document.getElementById('nav-body');
            
            if (currentTab === 'home') {
                homeBtn.classList.replace('text-slate-400', 'text-indigo-600');
                bodyBtn.classList.replace('text-indigo-600', 'text-slate-400');
            } else {
                bodyBtn.classList.replace('text-slate-400', 'text-indigo-600');
                homeBtn.classList.replace('text-indigo-600', 'text-slate-400');
            }
        }

        function startPlaceholderRotation() {
            const input = document.getElementById('main-input');
            if (!input) return;
            setInterval(() => {
                if (currentTab === 'home' && !currentSession) {
                    placeholderIdx = (placeholderIdx + 1) % placeholders.length;
                    const el = document.getElementById('main-input');
                    if (el) el.placeholder = placeholders[placeholderIdx];
                }
            }, 3000);
        }

        // --- Rendering ---

        function renderContent() {
            const container = document.getElementById('app-content');
            if (currentTab === 'home') {
                renderHome(container);
            } else {
                renderBody(container);
            }
            container.scrollTop = container.scrollHeight;
        }

        function renderHome(container) {
            if (!currentSession) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-[80vh] px-8 fade-in">
                        <h1 class="text-3xl font-light tracking-widest text-slate-800 mb-2">ANSWER</h1>
                        <p class="text-slate-400 text-sm mb-12">당신의 몸을 기억하는 파트너</p>
                        
                        <div class="w-full relative">
                            <input type="text" id="main-input" 
                                class="w-full bg-white border border-slate-200 rounded-2xl px-6 py-5 pr-14 premium-shadow outline-none focus:border-indigo-300 transition-all text-slate-700"
                                placeholder="${placeholders[0]}"
                                onkeypress="handleKeyPress(event)">
                            <button onclick="handleSend()" class="absolute right-4 top-1/2 -translate-y-1/2 text-indigo-500 hover:text-indigo-700 transition-colors">
                                <i data-lucide="arrow-up-circle" class="w-8 h-8"></i>
                            </button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="px-6 pt-12 pb-10 flex flex-col gap-6" id="chat-flow">
                        ${currentSession.questions.map((q, i) => `
                            <div class="flex justify-end fade-in">
                                <div class="bg-indigo-600 text-white px-5 py-3 rounded-2xl rounded-tr-none max-w-[85%] text-sm shadow-md">
                                    ${q}
                                </div>
                            </div>
                            <div class="flex justify-start fade-in">
                                <div class="glass-card text-slate-700 px-5 py-3 rounded-2xl rounded-tl-none max-w-[85%] text-sm premium-shadow">
                                    ${currentSession.responses[i] || '<span class="loading-dots">분석 중</span>'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <!-- Fixed Footer Input for Chat -->
                    <div class="fixed bottom-20 left-1/2 -translate-x-1/2 w-full max-w-[480px] px-6">
                        <div class="relative">
                            <input type="text" id="chat-input" 
                                class="w-full bg-white border border-slate-100 rounded-full px-6 py-4 pr-14 shadow-lg outline-none focus:border-indigo-200 text-sm"
                                placeholder="답변을 입력하세요..."
                                onkeypress="handleKeyPress(event)">
                            <button onclick="handleSend()" class="absolute right-3 top-1/2 -translate-y-1/2 text-indigo-500">
                                <i data-lucide="send" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function renderBody(container) {
            const summary = history.length > 0 ? history[0].finalReport.summary : "아직 기록된 역사가 없습니다. 첫 질문을 시작해보세요.";
            
            // Areas I'm Watching Logic
            const areaStatus = calculateAreaStatus();

            container.innerHTML = `
                <div class="px-6 pt-10 fade-in">
                    <header class="mb-8">
                        <h2 class="text-2xl font-semibold text-slate-800">My Body History</h2>
                        <p class="text-slate-400 text-xs mt-1">기억은 쌓일수록 더 정교해집니다.</p>
                    </header>

                    <!-- Recent Summary -->
                    <section class="mb-8">
                        <div class="glass-card p-6 rounded-3xl premium-shadow border-l-4 border-indigo-500">
                            <h3 class="text-xs font-bold text-indigo-600 mb-2 uppercase tracking-tighter">Recent Body Summary</h3>
                            <p class="text-slate-700 text-sm leading-relaxed">${summary}</p>
                            ${history.length > 0 ? `<button onclick="viewDetail('${history[0].id}')" class="mt-4 text-xs font-semibold text-indigo-500 flex items-center gap-1">전체 리포트 보기 <i data-lucide="chevron-right" class="w-3 h-3"></i></button>` : ''}
                        </div>
                    </section>

                    <!-- Areas I'm Watching -->
                    <section class="mb-8">
                        <h3 class="text-sm font-semibold text-slate-800 mb-4">Areas I'm Watching</h3>
                        <div class="grid grid-cols-2 gap-3">
                            ${areaStatus.map(area => `
                                <div class="bg-white p-4 rounded-2xl border border-slate-50 shadow-sm">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-xs font-medium text-slate-500">${area.name}</span>
                                        <div class="w-2 h-2 rounded-full ${area.color}"></div>
                                    </div>
                                    <span class="text-sm font-bold text-slate-800">${area.status}</span>
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <!-- History Search & List -->
                    <section class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-semibold text-slate-800 uppercase tracking-widest">ANSWER Remembers</h3>
                            <span class="text-[10px] text-slate-400">${history.length} Memories</span>
                        </div>
                        <div class="relative mb-4">
                            <input type="text" id="history-search" oninput="filterHistory()" placeholder="기억 검색..." class="w-full bg-slate-100 border-none rounded-xl px-4 py-2 text-xs focus:ring-1 focus:ring-indigo-200">
                            <i data-lucide="search" class="absolute right-3 top-2.5 w-3.5 h-3.5 text-slate-400"></i>
                        </div>
                        <div id="history-list" class="flex flex-col gap-3">
                            ${renderHistoryItems(history)}
                        </div>
                    </section>

                    <!-- Record Upload -->
                    <section class="mb-10 p-6 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200 text-center">
                        <i data-lucide="upload-cloud" class="w-8 h-8 text-slate-300 mx-auto mb-2"></i>
                        <h4 class="text-sm font-semibold text-slate-600">건강 기록 업로드</h4>
                        <p class="text-[11px] text-slate-400 mt-1 mb-4">검진 결과 사진이나 PDF를 올려주시면<br>기억의 깊이가 더 깊어집니다. (선택사항)</p>
                        <button class="btn btn-sm btn-outline border-slate-300 text-slate-500 hover:bg-slate-200 hover:border-slate-200 rounded-full px-6">파일 선택</button>
                    </section>

                    <p class="text-center text-[10px] text-slate-300 mb-10">ANSWER v0.0.8 | Memory gets more accurate over time.</p>
                </div>
            `;
            lucide.createIcons();
        }

        function renderHistoryItems(items) {
            if (items.length === 0) return `<p class="text-center py-10 text-slate-300 text-xs">기록된 질문이 없습니다.</p>`;
            return items.map(item => `
                <div onclick="viewDetail('${item.id}')" class="bg-white p-4 rounded-2xl border border-slate-50 shadow-sm flex justify-between items-center active:scale-[0.98] transition-transform">
                    <div class="flex-1">
                        <div class="flex gap-1 mb-1">
                            ${item.finalReport.relatedSystems.map(tag => `<span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${tag}</span>`).join('')}
                        </div>
                        <p class="text-sm text-slate-700 font-medium truncate pr-4">${item.userQuestion}</p>
                        <span class="text-[10px] text-slate-400">${new Date(item.createdAt).toLocaleDateString()}</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                </div>
            `).join('');
        }

        // --- Interaction Handlers ---

        function handleKeyPress(e) {
            if (e.key === 'Enter') handleSend();
        }

        async function handleSend() {
            const inputId = currentSession ? 'chat-input' : 'main-input';
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if (!text || isTyping) return;

            if (!currentSession) {
                currentSession = { id: Date.now().toString(), questions: [text], responses: [], step: 0 };
            } else {
                currentSession.questions.push(text);
                currentSession.step++;
            }
            
            input.value = '';
            renderContent();
            
            isTyping = true;
            await simulateAIResponse();
            isTyping = false;
            
            renderContent();
            lucide.createIcons();
        }

        async function simulateAIResponse() {
            // Simulated /api/chat logic
            await new Promise(r => setTimeout(r, 1500));
            
            let response = "";
            const step = currentSession.step;
            const initialQ = currentSession.questions[0];

            if (step === 0) {
                response = `단서가 보입니다. ${initialQ.includes('잠') ? '수면의 질을 더 파악하고 싶어요. 자고 일어났을 때 개운한 편인가요, 아니면 머리가 무거운가요?' : '이 증상이 나타날 때 다른 동반되는 감각(예: 소화불량, 두통 등)이 있나요?'}`;
            } else if (step === 1) {
                response = `알려주셔서 감사합니다. 혹시 이 증상이 최근 스트레스를 많이 받거나 식습관이 바뀌었을 때 더 심해지는 경향이 있나요?`;
            } else {
                // Final Report Generation
                const finalReport = generateFinalReport(currentSession);
                currentSession.finalReport = finalReport;
                saveToHistory(currentSession);
                response = renderFinalReportCard(finalReport);
            }
            
            currentSession.responses.push(response);
        }

        function generateFinalReport(session) {
            const q = session.questions[0];
            return {
                title: "종합 신체 흐름 분석",
                summary: `지금 질문만으로도 몸의 신호가 보입니다. ${q}와 관련된 불편함은 단순한 일시적 증상이 아니라, 현재 몸의 에너지가 '회복 모드'보다는 '대처 모드'에 집중되어 있음을 시사합니다.`,
                relatedSystems: q.includes('잠') ? ["수면 리듬", "신경계"] : ["소화계", "에너지 대사"],
                observedPatterns: [
                    "야간 회복 호르몬의 불균형 가능성",
                    "신경계 긴장도가 높은 상태 유지",
                    "특정 시간대 에너지 저하 패턴"
                ],
                oneActionToday: q.includes('잠') ? "오늘 밤 10시 이후 스마트폰 사용을 중단하고 10분간 명상을 해보세요." : "다음 식사 시 평소보다 2배 더 천천히 씹어보세요.",
                safetyNote: "이 분석은 의학적 진단이 아닙니다. 심한 통증이나 고열이 동반된다면 즉시 전문의와 상담하십시오.",
                references: [
                    { type: "textbook", citation: "Guyton & Hall. Textbook of Medical Physiology." },
                    { type: "paper", citation: "Walker M. Why We Sleep: Unlocking the Power of Sleep and Dreams." }
                ]
            };
        }

        function renderFinalReportCard(report) {
            return `
                <div class="flex flex-col gap-4">
                    <div class="flex items-center gap-2 text-indigo-600">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <span class="font-bold text-base">FINAL REPORT</span>
                    </div>
                    <div class="bg-white rounded-xl p-4 premium-shadow border border-indigo-50">
                        <h4 class="font-bold text-slate-800 mb-2">${report.title}</h4>
                        <p class="text-xs text-slate-600 leading-relaxed mb-4">${report.summary}</p>
                        
                        <div class="flex flex-wrap gap-1 mb-4">
                            ${report.relatedSystems.map(s => `<span class="bg-indigo-50 text-indigo-600 text-[10px] font-bold px-2 py-1 rounded-full">#${s}</span>`).join('')}
                        </div>

                        <div class="space-y-2 mb-4">
                            <p class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Observed Patterns</p>
                            ${report.observedPatterns.map(p => `<div class="flex items-start gap-2 text-xs text-slate-700"><span class="text-indigo-400">•</span>${p}</div>`).join('')}
                        </div>

                        <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-4">
                            <p class="text-[11px] font-bold text-indigo-600 mb-1">Today's Action</p>
                            <p class="text-xs text-slate-700">${report.oneActionToday}</p>
                        </div>

                        <p class="text-[9px] text-slate-400 mb-4 italic leading-tight">${report.safetyNote}</p>

                        <div class="border-t pt-3">
                            <p class="text-[10px] font-bold text-slate-400 mb-2">References</p>
                            ${report.references.map(ref => `<p class="text-[9px] text-slate-500 mb-1 leading-snug">[${ref.type}] ${ref.citation}</p>`).join('')}
                        </div>
                    </div>
                    <p class="text-center text-[10px] text-slate-300">ANSWER는 시간이 지날수록 더 정확해집니다.</p>
                </div>
            `;
        }

        function saveToHistory(session) {
            const historyItem = {
                id: session.id,
                createdAt: new Date().toISOString(),
                userQuestion: session.questions[0],
                finalReport: session.finalReport
            };
            history.unshift(historyItem);
            localStorage.setItem('answer_history_v1', JSON.stringify(history));
        }

        function viewDetail(id) {
            const item = history.find(h => h.id === id);
            if (!item) return;

            const modal = document.getElementById('report_modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <div class="mb-6">
                    <span class="text-[10px] font-bold text-slate-400">${new Date(item.createdAt).toLocaleString()}</span>
                    <h3 class="text-xl font-bold text-slate-800 mt-1">${item.userQuestion}</h3>
                </div>
                ${renderFinalReportCard(item.finalReport)}
                <div class="mt-8">
                    <button onclick="deleteHistory('${item.id}')" class="text-xs text-red-400 underline">이 기억 삭제하기</button>
                </div>
            `;
            
            modal.showModal();
            lucide.createIcons();
        }

        function deleteHistory(id) {
            history = history.filter(h => h.id !== id);
            localStorage.setItem('answer_history_v1', JSON.stringify(history));
            document.getElementById('report_modal').close();
            if (currentTab === 'body') renderContent();
        }

        function filterHistory() {
            const query = document.getElementById('history-search').value.toLowerCase();
            const filtered = history.filter(h => 
                h.userQuestion.toLowerCase().includes(query) || 
                h.finalReport.relatedSystems.some(s => s.toLowerCase().includes(query))
            );
            document.getElementById('history-list').innerHTML = renderHistoryItems(filtered);
            lucide.createIcons();
        }

        function calculateAreaStatus() {
            const areas = [
                { name: "수면 리듬", keywords: ["잠", "수면", "피곤", "피로"], status: "안정적", color: "bg-emerald-400", count: 0 },
                { name: "소화 반응", keywords: ["소화", "위", "배", "더부룩", "가스"], status: "안정적", color: "bg-emerald-400", count: 0 },
                { name: "에너지 대사", keywords: ["기운", "활력", "피로", "무기력"], status: "안정적", color: "bg-emerald-400", count: 0 },
                { name: "스트레스/심리", keywords: ["긴장", "불안", "두근", "스트레스"], status: "안정적", color: "bg-emerald-400", count: 0 }
            ];

            history.forEach(h => {
                areas.forEach(a => {
                    if (a.keywords.some(k => h.userQuestion.includes(k))) a.count++;
                });
            });

            areas.forEach(a => {
                if (a.count >= 3) { a.status = "주의"; a.color = "bg-amber-400"; }
                else if (a.count >= 1) { a.status = "관찰중"; a.color = "bg-sky-400"; }
            });

            return areas;
        }

        // --- Start App ---
        window.onload = init;
    </script>
</body>
</html>
<!-- 
    [배포를 위한 서버리스 함수 구조 제안]
    Vercel 배포 시 /api/chat.js 파일을 생성하고 아래와 같이 OpenAI API를 연동하세요:
    
    import OpenAI from 'openai';
    const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
    
    export default async function handler(req, res) {
        const { messages } = req.body;
        const completion = await openai.chat.completions.create({
            model: "gpt-4-turbo-preview",
            messages: [
                { role: "system", content: "당신은 ANSWER의 건강 파트너 AI입니다. 진단하지 말고 의학적 추론만 제공하세요. 6개 섹션 형식을 지키세요." },
                ...messages
            ],
        });
        res.status(200).json(completion.choices[0].message);
    }
-->
<ctrl46>
